# 生产环境问题修复计划

**创建日期**: 2026-01-28  
**优先级**: 高  
**目标**: 修复生产环境发现的问题

---

## 问题清单

### 问题 1: keyan 用户登录失败 ❌

**严重程度**: 高  
**影响范围**: 科研处用户无法登录系统

**问题描述**:
- 用户名: keyan
- 密码: 123456
- 错误: 401 未授权
- 其他用户 (zhanlue, jiaowu) 登录正常

**可能原因**:
1. 用户数据未正确迁移到生产数据库
2. 密码哈希不匹配
3. 用户状态异常 (is_active = false)
4. 组织关联错误

**修复步骤**:
1. 检查生产数据库中 keyan 用户的记录
   ```sql
   SELECT user_id, username, real_name, org_id, is_active, password_hash
   FROM app_user
   WHERE username = 'keyan';
   ```

2. 验证密码哈希是否正确
   - 预期哈希: `$2a$10$N9qo8uLOickgx2ZMRZoMy.MqrqQlBNe/YnHOl4EKMry1xLzJypGGi`
   - 对应密码: 123456

3. 检查用户状态
   ```sql
   UPDATE app_user
   SET is_active = TRUE
   WHERE username = 'keyan';
   ```

4. 验证组织关联
   ```sql
   SELECT u.username, u.real_name, o.org_name, o.org_type
   FROM app_user u
   LEFT JOIN org o ON u.org_id = o.org_id
   WHERE u.username = 'keyan';
   ```

5. 如果用户不存在，重新插入
   ```sql
   INSERT INTO app_user (username, real_name, org_id, password_hash, is_active)
   VALUES ('keyan', '王科研', 3, '$2a$10$N9qo8uLOickgx2ZMRZoMy.MqrqQlBNe/YnHOl4EKMry1xLzJypGGi', TRUE)
   ON CONFLICT (username) DO UPDATE
   SET password_hash = EXCLUDED.password_hash,
       is_active = TRUE;
   ```

**验证方法**:
```bash
curl -X POST https://blackevil.cn/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"keyan","password":"123456"}'
```

预期结果: 返回 200 OK 和 JWT token

---

### 问题 2: 考核周期 API 返回 500 错误 ❌

**严重程度**: 高  
**影响范围**: 无法获取考核周期列表，影响前端页面加载

**问题描述**:
- 端点: GET /api/cycles
- 错误: 500 Internal Server Error
- 错误码: SYS_001
- 错误信息: Internal server error

**可能原因**:
1. assessment_cycle 表不存在或结构错误
2. 表中没有数据
3. 查询语句错误
4. 数据库连接问题
5. 实体映射错误

**修复步骤**:

1. 检查后端日志
   ```bash
   ssh user@blackevil.cn
   sudo journalctl -u sism-backend -n 100 --no-pager | grep -A 10 "cycles"
   ```

2. 检查数据库表结构
   ```sql
   \d assessment_cycle
   ```

3. 检查表中的数据
   ```sql
   SELECT cycle_id, cycle_name, year, start_date, end_date
   FROM assessment_cycle
   ORDER BY year DESC;
   ```

4. 如果表为空，插入测试数据
   ```sql
   INSERT INTO assessment_cycle (cycle_name, year, start_date, end_date, description)
   VALUES 
     ('2026年度考核周期', 2026, '2026-01-01', '2026-12-31', '2026年度战略指标考核周期'),
     ('2025年度考核周期', 2025, '2025-01-01', '2025-12-31', '2025年度战略指标考核周期')
   ON CONFLICT DO NOTHING;
   ```

5. 检查 CycleController 和 CycleService 代码
   - 验证查询逻辑
   - 检查异常处理
   - 确认实体映射正确

6. 重启后端服务
   ```bash
   sudo systemctl restart sism-backend
   sudo systemctl status sism-backend
   ```

**验证方法**:
```bash
# 获取 token
TOKEN=$(curl -s -X POST https://blackevil.cn/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"zhanlue","password":"123456"}' | jq -r '.data.token')

# 测试 cycles API
curl -H "Authorization: Bearer $TOKEN" https://blackevil.cn/api/cycles
```

预期结果: 返回 200 OK 和考核周期列表

---

## 修复优先级

| 优先级 | 问题 | 预计时间 | 负责人 |
|--------|------|----------|--------|
| P0 | 考核周期 API 错误 | 30分钟 | 后端开发 |
| P1 | keyan 用户登录失败 | 15分钟 | 后端开发 |

---

## 修复流程

### 阶段 1: 问题诊断 (15分钟)
1. SSH 登录生产服务器
2. 检查后端日志
3. 连接生产数据库
4. 执行诊断 SQL 查询
5. 记录问题根因

### 阶段 2: 问题修复 (30分钟)
1. 根据诊断结果执行修复 SQL
2. 如需代码修改，在本地修复并测试
3. 提交代码到 GitHub
4. 等待 GitHub Actions 自动部署
5. 或手动部署修复

### 阶段 3: 验证测试 (15分钟)
1. 测试 keyan 用户登录
2. 测试考核周期 API
3. 测试其他相关功能
4. 更新验证报告

### 阶段 4: 文档更新 (10分钟)
1. 更新生产环境验证报告
2. 记录修复过程
3. 更新部署文档

---

## 数据库诊断脚本

创建诊断脚本 `diagnose-production.sql`:

```sql
-- 1. 检查用户表
SELECT 'User Check' AS check_type;
SELECT user_id, username, real_name, org_id, is_active, 
       LEFT(password_hash, 20) || '...' AS password_hash_preview
FROM app_user
WHERE username IN ('zhanlue', 'jiaowu', 'keyan', 'admin')
ORDER BY username;

-- 2. 检查考核周期表
SELECT 'Cycle Check' AS check_type;
SELECT cycle_id, cycle_name, year, start_date, end_date
FROM assessment_cycle
ORDER BY year DESC;

-- 3. 检查组织表
SELECT 'Org Check' AS check_type;
SELECT org_id, org_name, org_type, parent_org_id
FROM org
WHERE org_id IN (1, 2, 3, 4, 5)
ORDER BY org_id;

-- 4. 检查 Flyway 迁移历史
SELECT 'Migration Check' AS check_type;
SELECT installed_rank, version, description, type, script, 
       installed_on, execution_time, success
FROM flyway_schema_history
ORDER BY installed_rank DESC
LIMIT 10;

-- 5. 检查表统计
SELECT 'Table Stats' AS check_type;
SELECT 
  'app_user' AS table_name, COUNT(*) AS row_count FROM app_user
UNION ALL
SELECT 'org', COUNT(*) FROM org
UNION ALL
SELECT 'assessment_cycle', COUNT(*) FROM assessment_cycle
UNION ALL
SELECT 'indicators', COUNT(*) FROM indicators
UNION ALL
SELECT 'strategic_task', COUNT(*) FROM strategic_task;
```

---

## 修复验证清单

修复完成后，执行以下验证：

### 用户登录验证
- [ ] zhanlue 用户登录成功
- [ ] jiaowu 用户登录成功
- [ ] keyan 用户登录成功
- [ ] 所有用户获取正确的 JWT token
- [ ] 所有用户信息完整

### API 功能验证
- [ ] GET /api/cycles 返回 200
- [ ] GET /api/orgs 返回 200
- [ ] GET /api/indicators 返回 200
- [ ] 所有 API 返回正确的数据结构

### 数据完整性验证
- [ ] 用户表数据完整
- [ ] 组织表数据完整
- [ ] 考核周期表数据完整
- [ ] 指标表数据完整

---

## 回滚计划

如果修复失败，执行以下回滚步骤：

1. **数据库回滚**:
   ```bash
   # 恢复数据库备份
   pg_restore -h localhost -U sism_user -d sism_db backup.dump
   ```

2. **代码回滚**:
   ```bash
   # 回滚到上一个稳定版本
   git revert <commit-hash>
   git push origin main
   ```

3. **服务回滚**:
   ```bash
   # 恢复之前的 JAR 文件
   sudo systemctl stop sism-backend
   sudo cp /opt/sism/backend/sism-backend.jar.backup /opt/sism/backend/sism-backend.jar
   sudo systemctl start sism-backend
   ```

---

## 联系信息

**技术支持**: 
- 后端开发团队
- 数据库管理员
- DevOps 团队

**紧急联系**: 
- 如问题无法解决，立即联系技术负责人

---

**文档创建**: 2026-01-28 13:30 UTC+8  
**最后更新**: 2026-01-28 13:30 UTC+8
