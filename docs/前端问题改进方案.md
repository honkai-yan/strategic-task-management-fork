# 战略指标管理系统 - 前端问题改进方案

> 基于测试报告的问题修复指南

---

## 一、P1: 登录功能修复

### 问题定位
文件：`src/views/LoginView.vue`

### 修复方案

```vue
// 修改 handleLogin 函数
const handleLogin = async () => {
  // 1. 添加 ref 检查日志
  console.log('loginFormRef:', loginFormRef.value)
  
  if (!loginFormRef.value) {
    console.error('loginFormRef is null')
    // 备用方案：直接验证
    if (!loginForm.username || !loginForm.password) {
      ElMessage.warning('请输入用户名和密码')
      return
    }
  } else {
    try {
      await loginFormRef.value.validate()
    } catch (err) {
      console.log('Form validation failed:', err)
      return
    }
  }

  // 继续登录逻辑...
}
```

### 根本原因排查
1. 检查 `el-form` 的 `ref` 绑定是否正确
2. 确认 `@keyup.enter` 事件是否正确触发
3. 验证 Element Plus 版本兼容性

### 临时解决方案
在 `LoginView.vue` 的 `handleLogin` 中添加：
```typescript
// 跳过表单验证，直接执行登录逻辑
if (loginForm.username.length >= 3 && loginForm.password.length >= 6) {
  // 执行登录
}
```

---

## 二、P2: 新增指标功能修复

### 问题定位
文件：`src/views/StrategicTaskView.vue`

### 修复方案

```vue
<script setup>
// 确保 addNewRow 正确设置状态
const addNewRow = () => {
  console.log('addNewRow called, current isAddingOrEditing:', isAddingOrEditing.value)
  isAddingOrEditing.value = true
  console.log('after set, isAddingOrEditing:', isAddingOrEditing.value)
}
</script>

<template>
  <!-- 确保新增表单的 v-if 条件正确 -->
  <div v-if="isAddingOrEditing" class="add-form">
    <!-- 新增表单内容 -->
  </div>
</template>
```

### 检查清单
1. [ ] 确认 `isAddingOrEditing` 是 `ref(false)` 而非普通变量
2. [ ] 检查新增表单的 `v-if` 条件是否正确
3. [ ] 确认表单组件没有被 CSS 隐藏
4. [ ] 检查是否有其他逻辑重置了 `isAddingOrEditing`

---

## 三、P3: 标签页切换优化

### 问题定位
文件：`src/App.vue`

### 修复方案

```vue
<template>
  <div class="tab-nav">
    <div
      v-for="tab in tabs"
      :key="tab.id"
      :class="['tab-item', { active: activeTab === tab.id }]"
      @click.stop="handleTabClick(tab.id)"
    >
      <el-icon :size="20"><component :is="tab.icon" /></el-icon>
      <span>{{ tab.label }}</span>
    </div>
  </div>
</template>

<script setup>
// 添加明确的点击处理函数
const handleTabClick = (tabId: string) => {
  console.log('Tab clicked:', tabId)
  activeTab.value = tabId
}
</script>
```

### 优化建议
1. 使用 `@click.stop` 防止事件冒泡
2. 添加点击反馈动画
3. 考虑使用 Element Plus 的 `el-tabs` 组件替代自定义实现

---

## 四、P4: ECharts 组件导入修复

### 问题定位
ECharts 相关组件文件

### 修复方案

```typescript
// 在使用 ECharts 的组件中添加完整导入
import { use } from 'echarts/core'
import { CanvasRenderer } from 'echarts/renderers'
import { PieChart, BarChart, LineChart } from 'echarts/charts'
import {
  TitleComponent,
  TooltipComponent,
  LegendComponent,
  GridComponent,
  GraphicComponent  // 添加这个
} from 'echarts/components'

use([
  CanvasRenderer,
  PieChart,
  BarChart,
  LineChart,
  TitleComponent,
  TooltipComponent,
  LegendComponent,
  GridComponent,
  GraphicComponent  // 添加这个
])
```

---

## 五、P5: 数据看板角色过滤

### 问题定位
文件：`src/views/DashboardView.vue`

### 修复方案

```typescript
// 根据用户角色过滤数据
const filteredIndicators = computed(() => {
  const userRole = authStore.userRole
  const userDept = authStore.userDepartment
  
  switch (userRole) {
    case 'strategic_dept':
      // 战略发展部：显示全部数据
      return allIndicators.value
      
    case 'functional_dept':
      // 职能部门：显示本部门及下属单位数据
      return allIndicators.value.filter(i => 
        i.ownerDept === userDept || i.responsibleDept === userDept
      )
      
    case 'secondary_college':
      // 二级学院：只显示本学院数据
      return allIndicators.value.filter(i => 
        i.responsibleDept === userDept
      )
      
    default:
      return []
  }
})
```

---

## 六、代码质量改进建议

### 1. 添加错误边界
```vue
<template>
  <ErrorBoundary>
    <DashboardView />
  </ErrorBoundary>
</template>
```

### 2. 添加加载状态
```vue
<template>
  <div v-if="loading" class="loading-spinner">
    <el-skeleton :rows="5" animated />
  </div>
  <div v-else>
    <!-- 实际内容 -->
  </div>
</template>
```

### 3. 添加空状态处理
```vue
<template>
  <el-empty v-if="indicators.length === 0" description="暂无指标数据" />
  <el-table v-else :data="indicators">
    <!-- 表格内容 -->
  </el-table>
</template>
```

### 4. 统一错误提示
```typescript
// utils/errorHandler.ts
export const handleError = (error: Error, context: string) => {
  console.error(`[${context}]`, error)
  ElMessage.error(`操作失败: ${error.message}`)
}
```

---

## 七、测试用例补充建议

### 单元测试
```typescript
// tests/unit/LoginView.spec.ts
describe('LoginView', () => {
  it('should validate form before submit', async () => {
    // ...
  })
  
  it('should show error message on invalid credentials', async () => {
    // ...
  })
  
  it('should redirect to dashboard on successful login', async () => {
    // ...
  })
})
```

### E2E 测试
```typescript
// tests/e2e/login.spec.ts
test('complete login flow', async ({ page }) => {
  await page.goto('/login')
  await page.fill('[placeholder="请输入用户名"]', 'admin')
  await page.fill('[placeholder="请输入密码"]', '123456')
  await page.click('button:has-text("登 录")')
  await expect(page).toHaveURL('/dashboard')
})
```

---

## 八、优先级排序

| 优先级 | 问题 | 预计工时 | 影响范围 |
|:-----:|-----|:-------:|---------|
| P0 | 登录功能修复 | 2h | 所有用户 |
| P1 | 新增指标功能修复 | 2h | 战略发展部 |
| P2 | 标签页切换优化 | 1h | 所有用户 |
| P3 | ECharts 组件导入 | 0.5h | 图表显示 |
| P4 | 数据看板角色过滤 | 3h | 数据准确性 |

---

*文档更新时间：2025-12-26*
