# ç”Ÿäº§ç¯å¢ƒé—®é¢˜ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2026-01-28  
**ä¿®å¤å·¥ç¨‹å¸ˆ**: AI Development Engineer  
**ä¿®å¤çŠ¶æ€**: âœ… ä»£ç å·²æäº¤ï¼Œç­‰å¾…éƒ¨ç½²

---

## ä¿®å¤æ¦‚è¿°

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ç”Ÿäº§ç¯å¢ƒæµ‹è¯•ä¸­å‘ç°çš„ 2 ä¸ªé«˜ä¼˜å…ˆçº§é—®é¢˜ï¼š

1. **è€ƒæ ¸å‘¨æœŸ API é”™è¯¯** (500 Internal Server Error)
2. **keyan ç”¨æˆ·ç™»å½•å¤±è´¥** (401 æœªæˆæƒ)

---

## é—®é¢˜ 1: è€ƒæ ¸å‘¨æœŸ API é”™è¯¯ âœ…

### é—®é¢˜æè¿°
- **ç«¯ç‚¹**: GET /api/cycles
- **é”™è¯¯**: 500 Internal Server Error
- **é”™è¯¯ç **: SYS_001
- **å½±å“**: å‰ç«¯æ— æ³•è·å–è€ƒæ ¸å‘¨æœŸåˆ—è¡¨

### æ ¹å› åˆ†æ
ç»è¿‡ä»£ç æ£€æŸ¥ï¼Œå‘ç°åç«¯ç¼ºå°‘ `AssessmentCycleController`ï¼Œå¯¼è‡´ `/api/cycles` ç«¯ç‚¹ä¸å­˜åœ¨ã€‚è™½ç„¶æ•°æ®åº“ä¸­æœ‰ `assessment_cycle` è¡¨å’Œç›¸å…³çš„ Repositoryï¼Œä½†æ²¡æœ‰å¯¹åº”çš„ Controller å’Œ Service æ¥å¤„ç† HTTP è¯·æ±‚ã€‚

### ä¿®å¤æ–¹æ¡ˆ

#### 1. åˆ›å»º AssessmentCycleVO
**æ–‡ä»¶**: `src/main/java/com/sism/vo/AssessmentCycleVO.java`

```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class AssessmentCycleVO {
    private Long cycleId;
    private String cycleName;
    private Integer year;
    private LocalDate startDate;
    private LocalDate endDate;
    private String description;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

#### 2. åˆ›å»º AssessmentCycleService
**æ–‡ä»¶**: `src/main/java/com/sism/service/AssessmentCycleService.java`

**åŠŸèƒ½**:
- `getAllCycles()`: è·å–æ‰€æœ‰è€ƒæ ¸å‘¨æœŸï¼ˆæŒ‰å¹´ä»½é™åºï¼‰
- `getCycleById(Long)`: æ ¹æ® ID è·å–è€ƒæ ¸å‘¨æœŸ
- `getCycleByYear(Integer)`: æ ¹æ®å¹´ä»½è·å–è€ƒæ ¸å‘¨æœŸ
- `getActiveOrFutureCycles()`: è·å–æ´»è·ƒæˆ–æœªæ¥çš„è€ƒæ ¸å‘¨æœŸ
- `getCycleByDate(LocalDate)`: æ ¹æ®æ—¥æœŸè·å–è€ƒæ ¸å‘¨æœŸ

#### 3. åˆ›å»º AssessmentCycleController
**æ–‡ä»¶**: `src/main/java/com/sism/controller/AssessmentCycleController.java`

**API ç«¯ç‚¹**:
- `GET /cycles`: è·å–æ‰€æœ‰è€ƒæ ¸å‘¨æœŸ
- `GET /cycles/{cycleId}`: æ ¹æ® ID è·å–è€ƒæ ¸å‘¨æœŸ
- `GET /cycles/year/{year}`: æ ¹æ®å¹´ä»½è·å–è€ƒæ ¸å‘¨æœŸ
- `GET /cycles/active`: è·å–æ´»è·ƒçš„è€ƒæ ¸å‘¨æœŸ
- `GET /cycles/date/{date}`: æ ¹æ®æ—¥æœŸè·å–è€ƒæ ¸å‘¨æœŸ

### ä¿®å¤éªŒè¯

#### ç¼–è¯‘æµ‹è¯•
```bash
cd sism-backend
./mvnw clean compile -DskipTests
```
**ç»“æœ**: âœ… ç¼–è¯‘æˆåŠŸ

#### ä»£ç æäº¤
```bash
git add src/main/java/com/sism/controller/AssessmentCycleController.java
git add src/main/java/com/sism/service/AssessmentCycleService.java
git add src/main/java/com/sism/vo/AssessmentCycleVO.java
git commit -m "fix: æ·»åŠ è€ƒæ ¸å‘¨æœŸ API ç«¯ç‚¹"
git push origin main
```
**ç»“æœ**: âœ… å·²æ¨é€åˆ° GitHub (commit: c07c869)

#### éƒ¨ç½²åéªŒè¯æ­¥éª¤
1. ç­‰å¾… GitHub Actions è‡ªåŠ¨éƒ¨ç½²ï¼ˆçº¦ 5-10 åˆ†é’Ÿï¼‰
2. æµ‹è¯• API ç«¯ç‚¹:
   ```bash
   # è·å– token
   TOKEN=$(curl -s -X POST https://blackevil.cn/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"zhanlue","password":"123456"}' | jq -r '.data.token')
   
   # æµ‹è¯• cycles API
   curl -H "Authorization: Bearer $TOKEN" https://blackevil.cn/api/cycles
   ```
3. é¢„æœŸç»“æœ: è¿”å› 200 OK å’Œè€ƒæ ¸å‘¨æœŸåˆ—è¡¨

---

## é—®é¢˜ 2: keyan ç”¨æˆ·ç™»å½•å¤±è´¥ âœ…

### é—®é¢˜æè¿°
- **ç”¨æˆ·å**: keyan
- **å¯†ç **: 123456
- **é”™è¯¯**: 401 æœªæˆæƒ
- **å½±å“**: ç§‘ç ”å¤„ç”¨æˆ·æ— æ³•ç™»å½•ç³»ç»Ÿ

### æ ¹å› åˆ†æ
å¯èƒ½çš„åŸå› ï¼š
1. ç”¨æˆ·æ•°æ®æœªæ­£ç¡®è¿ç§»åˆ°ç”Ÿäº§æ•°æ®åº“
2. å¯†ç å“ˆå¸Œä¸åŒ¹é…
3. ç”¨æˆ·çŠ¶æ€ä¸º inactive
4. ç»„ç»‡å…³è”é”™è¯¯

### ä¿®å¤æ–¹æ¡ˆ

#### 1. åˆ›å»ºè¯Šæ–­è„šæœ¬
**æ–‡ä»¶**: `database/scripts/fix-keyan-user.sql`

**åŠŸèƒ½**:
- æ£€æŸ¥ keyan ç”¨æˆ·æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥ç§‘ç ”å¤„ç»„ç»‡æ˜¯å¦å­˜åœ¨
- ä¿®å¤æˆ–æ’å…¥ keyan ç”¨æˆ·
- éªŒè¯ä¿®å¤ç»“æœ

#### 2. åˆ›å»ºç»¼åˆä¿®å¤è„šæœ¬
**æ–‡ä»¶**: `database/scripts/diagnose-and-fix-production.sql`

**åŠŸèƒ½**:
- **è¯Šæ–­æ£€æŸ¥**:
  - æ£€æŸ¥æ‰€æœ‰æµ‹è¯•ç”¨æˆ·
  - æ£€æŸ¥ç»„ç»‡æ•°æ®
  - æ£€æŸ¥è€ƒæ ¸å‘¨æœŸæ•°æ®
  - æ£€æŸ¥ Flyway è¿ç§»å†å²
  - æ£€æŸ¥è¡¨ç»Ÿè®¡ä¿¡æ¯

- **é—®é¢˜ä¿®å¤**:
  - ç¡®ä¿æ‰€æœ‰æµ‹è¯•ç”¨æˆ·å­˜åœ¨ä¸”å¯†ç æ­£ç¡®
  - ç¡®ä¿è€ƒæ ¸å‘¨æœŸæ•°æ®å®Œæ•´
  - è‡ªåŠ¨éªŒè¯ä¿®å¤ç»“æœ

**ä¿®å¤çš„ç”¨æˆ·**:
| ç”¨æˆ·å | çœŸå®å§“å | ç»„ç»‡ | å¯†ç  | å¯†ç å“ˆå¸Œ |
|--------|----------|------|------|----------|
| zhanlue | å¼ æˆ˜ç•¥ | æˆ˜ç•¥å‘å±•éƒ¨ | 123456 | $2a$10$N9qo8uLOickgx2ZMRZoMy... |
| jiaowu | ææ•™åŠ¡ | æ•™åŠ¡å¤„ | 123456 | $2a$10$N9qo8uLOickgx2ZMRZoMy... |
| keyan | ç‹ç§‘ç ” | ç§‘ç ”å¤„ | 123456 | $2a$10$N9qo8uLOickgx2ZMRZoMy... |
| renshi | èµµäººäº‹ | äººäº‹å¤„ | 123456 | $2a$10$N9qo8uLOickgx2ZMRZoMy... |
| xuesheng | é’±å­¦ç”Ÿ | å­¦ç”Ÿå¤„ | 123456 | $2a$10$N9qo8uLOickgx2ZMRZoMy... |

### ä¿®å¤éªŒè¯

#### ä»£ç æäº¤
```bash
git add database/scripts/fix-keyan-user.sql
git add database/scripts/diagnose-and-fix-production.sql
git commit -m "fix: æ·»åŠ æ•°æ®åº“è¯Šæ–­å’Œä¿®å¤è„šæœ¬"
git push origin main
```
**ç»“æœ**: âœ… å·²æ¨é€åˆ° GitHub (commit: ff09251)

#### éƒ¨ç½²åæ‰§è¡Œæ­¥éª¤

**æ–¹å¼ 1: é€šè¿‡ SSH æ‰§è¡Œ**
```bash
# 1. SSH ç™»å½•ç”Ÿäº§æœåŠ¡å™¨
ssh user@blackevil.cn

# 2. ä¸‹è½½ä¿®å¤è„šæœ¬
cd /tmp
wget https://raw.githubusercontent.com/CDUESTC-OpenAtom-Club/sism-backend/main/database/scripts/diagnose-and-fix-production.sql

# 3. æ‰§è¡Œä¿®å¤è„šæœ¬
psql -h localhost -U sism_user -d sism_db -f diagnose-and-fix-production.sql

# 4. é‡å¯åç«¯æœåŠ¡
sudo systemctl restart sism-backend
sudo systemctl status sism-backend
```

**æ–¹å¼ 2: é€šè¿‡æ•°æ®åº“å®¢æˆ·ç«¯æ‰§è¡Œ**
1. è¿æ¥åˆ°ç”Ÿäº§æ•°æ®åº“
2. æ‰§è¡Œ `diagnose-and-fix-production.sql` è„šæœ¬
3. æ£€æŸ¥è¾“å‡ºç»“æœ
4. é‡å¯åç«¯æœåŠ¡

#### éªŒè¯æµ‹è¯•
```bash
# æµ‹è¯• keyan ç”¨æˆ·ç™»å½•
curl -X POST https://blackevil.cn/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"keyan","password":"123456"}'
```
**é¢„æœŸç»“æœ**: è¿”å› 200 OK å’Œ JWT token

---

## ä¿®å¤æ€»ç»“

### ä»£ç å˜æ›´ç»Ÿè®¡
| ä»“åº“ | æ–°å¢æ–‡ä»¶ | ä¿®æ”¹æ–‡ä»¶ | æ–°å¢è¡Œæ•° | æäº¤æ•° |
|------|----------|----------|----------|--------|
| sism-backend | 5 | 0 | 474 | 2 |

### æäº¤è®°å½•
1. **c07c869**: fix: æ·»åŠ è€ƒæ ¸å‘¨æœŸ API ç«¯ç‚¹
   - AssessmentCycleController.java
   - AssessmentCycleService.java
   - AssessmentCycleVO.java

2. **ff09251**: fix: æ·»åŠ æ•°æ®åº“è¯Šæ–­å’Œä¿®å¤è„šæœ¬
   - diagnose-and-fix-production.sql
   - fix-keyan-user.sql

### GitHub Actions çŠ¶æ€
- âœ… ä»£ç å·²æ¨é€åˆ° main åˆ†æ”¯
- â³ ç­‰å¾…è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµæ‰§è¡Œ
- ğŸ“ é¢„è®¡éƒ¨ç½²æ—¶é—´: 5-10 åˆ†é’Ÿ

---

## éƒ¨ç½²åéªŒè¯æ¸…å•

### è‡ªåŠ¨éƒ¨ç½²éªŒè¯
- [ ] GitHub Actions å·¥ä½œæµæˆåŠŸæ‰§è¡Œ
- [ ] åç«¯ JAR æ–‡ä»¶å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
- [ ] åç«¯æœåŠ¡å·²é‡å¯
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡ (/api/actuator/health)

### åŠŸèƒ½éªŒè¯
- [ ] è€ƒæ ¸å‘¨æœŸ API æµ‹è¯•
  - [ ] GET /api/cycles è¿”å› 200
  - [ ] è¿”å›æ•°æ®åŒ…å« 2024, 2025, 2026 å¹´åº¦å‘¨æœŸ
  - [ ] æ•°æ®ç»“æ„æ­£ç¡®

- [ ] ç”¨æˆ·ç™»å½•æµ‹è¯•
  - [ ] zhanlue ç”¨æˆ·ç™»å½•æˆåŠŸ
  - [ ] jiaowu ç”¨æˆ·ç™»å½•æˆåŠŸ
  - [ ] keyan ç”¨æˆ·ç™»å½•æˆåŠŸ âš ï¸ **é‡ç‚¹éªŒè¯**
  - [ ] renshi ç”¨æˆ·ç™»å½•æˆåŠŸ
  - [ ] xuesheng ç”¨æˆ·ç™»å½•æˆåŠŸ

### æ•°æ®åº“éªŒè¯
- [ ] æ‰§è¡Œè¯Šæ–­è„šæœ¬
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨æˆ·å­˜åœ¨ä¸”å¯†ç æ­£ç¡®
- [ ] è€ƒæ ¸å‘¨æœŸæ•°æ®å®Œæ•´
- [ ] ç»„ç»‡æ•°æ®æ­£ç¡®

---

## å›æ»šè®¡åˆ’

å¦‚æœä¿®å¤åä»æœ‰é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬ï¼š

### ä»£ç å›æ»š
```bash
# å›æ»šåˆ°ä¿®å¤å‰çš„ç‰ˆæœ¬
git revert ff09251 c07c869
git push origin main
```

### æ•°æ®åº“å›æ»š
```bash
# å¦‚æœæ•°æ®åº“æœ‰å¤‡ä»½
pg_restore -h localhost -U sism_user -d sism_db backup_before_fix.dump
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ (éƒ¨ç½²å)
1. â³ **ç­‰å¾… GitHub Actions éƒ¨ç½²å®Œæˆ**
   - ç›‘æ§éƒ¨ç½²æ—¥å¿—
   - ç¡®è®¤éƒ¨ç½²æˆåŠŸ

2. ğŸ”§ **æ‰§è¡Œæ•°æ®åº“ä¿®å¤è„šæœ¬**
   - SSH ç™»å½•ç”Ÿäº§æœåŠ¡å™¨
   - æ‰§è¡Œ diagnose-and-fix-production.sql
   - é‡å¯åç«¯æœåŠ¡

3. âœ… **éªŒè¯ä¿®å¤ç»“æœ**
   - æµ‹è¯•è€ƒæ ¸å‘¨æœŸ API
   - æµ‹è¯•æ‰€æœ‰ç”¨æˆ·ç™»å½•
   - æ›´æ–°éªŒè¯æŠ¥å‘Š

### åç»­è¡ŒåŠ¨
1. ğŸ“ æ›´æ–°ç”Ÿäº§ç¯å¢ƒéªŒè¯æŠ¥å‘Š
2. ğŸ¯ å®Œæˆæµè§ˆå™¨ç«¯åŠŸèƒ½æµ‹è¯•
3. ğŸ“Š ç›‘æ§ç”Ÿäº§ç¯å¢ƒè¿è¡ŒçŠ¶æ€
4. ğŸ“š æ›´æ–°éƒ¨ç½²æ–‡æ¡£

---

## ç›¸å…³æ–‡æ¡£

1. **æµ‹è¯•æŠ¥å‘Š**: `docs/ç”Ÿäº§ç¯å¢ƒéªŒè¯æŠ¥å‘Š-2026-01-28-å®Œæ•´æµ‹è¯•.md`
2. **é—®é¢˜ä¿®å¤è®¡åˆ’**: `docs/ç”Ÿäº§ç¯å¢ƒé—®é¢˜ä¿®å¤è®¡åˆ’-2026-01-28.md`
3. **æµ‹è¯•æ€»ç»“**: `docs/ç”Ÿäº§ç¯å¢ƒæµ‹è¯•æ€»ç»“-2026-01-28.md`
4. **æ•°æ®åº“è„šæœ¬**: 
   - `sism-backend/database/scripts/diagnose-and-fix-production.sql`
   - `sism-backend/database/scripts/fix-keyan-user.sql`

---

## è”ç³»ä¿¡æ¯

**æŠ€æœ¯æ”¯æŒ**: 
- åç«¯å¼€å‘å›¢é˜Ÿ
- æ•°æ®åº“ç®¡ç†å‘˜
- DevOps å›¢é˜Ÿ

**ç´§æ€¥è”ç³»**: 
- å¦‚éƒ¨ç½²å¤±è´¥æˆ–ä¿®å¤æ— æ•ˆï¼Œç«‹å³è”ç³»æŠ€æœ¯è´Ÿè´£äºº

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-28 13:45 UTC+8  
**ä¿®å¤å·¥ç¨‹å¸ˆ**: AI Development Engineer  
**å®¡æ ¸çŠ¶æ€**: å¾…éƒ¨ç½²éªŒè¯
